<project name='jam' default='all' basedir='.'>

  <!-- Properties -->

  <property name='build_dir'         value='build'/>
  <property name='src_dir'           value='src'/>
  <property name='src15_dir'         value='src15'/>
  <property name='classes_dir'       value='${build_dir}/classes'/>

  <property name='repackage_spec'
            value='org.apache.xmlbeans.impl.jam:${newpackage}'/>

  <property name='repackaged_src'   value='${build_dir}/repackaged_src'/>
  <property name='repackaged_src15' value='${build_dir}/repackaged_src15'/>

  <!-- Targets -->

  <target name='all' depends='clean,repackage_check,repackage_do'/>

  <target name='clean'>
    <ant dir='.' antfile='build.xml' target='clean' inheritAll='false' />
  </target>

  <target name='repackage_check' unless='newpackage'>
    <echo message='Please specify -Dnewpackage=[destination package]'/>
    <echo message='on the ant command line.'/>
  </target>

  <target name='repackage_do' if='newpackage'>

    <echo message='Building repackaged JAM under ${newpackage}...'/>
    <echo message=''/>


    <mkdir dir='${repackaged_src}'/>
    <mkdir dir='${repackaged_src15}'/>

    <mkdir dir='${classes_dir}'/>

    <javac srcdir='${src_dir}' destdir='${classes_dir}'
           source='1.4' target='1.4'
           includes='**/tools/*.java'/>


    <!-- we need to run the repackager for both src and src15, since
         it only supports one source directory parameter -->
    <java classname='org.apache.xmlbeans.impl.jam.tools.Repackage'
                    fork='true' failonerror='true'>
       <classpath><pathelement location='${classes_dir}'/></classpath>
       <arg line='-repackage ${repackage_spec} -f src -t ${repackaged_src}'/>
    </java>

    <java classname='org.apache.xmlbeans.impl.jam.tools.Repackage'
                    fork='true' failonerror='true'>
       <classpath><pathelement location='${classes_dir}'/></classpath>
      <arg line='-repackage ${repackage_spec} -f src15 -t ${repackaged_src15}'/>
    </java>



    <delete dir='${classes_dir}'/> <!-- don't need repackager any more -->

    <ant dir='.' target='jars' inheritAll='false' >
      <property name='src_dir' value='${repackaged_src}'/>
      <property name='src15_dir' value='${repackaged_src15}'/>
    </ant>
  </target>


</project>